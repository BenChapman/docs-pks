---
title: Cluster Configuration
owner: PKS
---

<strong><%= modified_date %></strong>

This topic describes how to configure clusters during a Pivotal Container Service (PKS) upgrade.

## <a id='overview'></a>Avoid Workload Downtime

To avoid workload downtime during a PKS upgrade, use the following configuration to scale clusters.

In the deployment manifest, increase the number of worker nodes to at least 2.
Define `podAntiAffinity` in the pod spec so that pod replicas are scheduled on separate workers.

For example:

```yaml
kind: Deployment
metadata:
  # ...
spec:
  replicas: 3
  template:
    metadata:
      labels:
        app: APP-NAME
    spec:
      containers:
      - name: MY-APP
        image: MY-IMAGE
        ports:
        - containerPort: 12345
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                    - APP-NAME
              topologyKey: "kubernetes.io/hostname"
```

See the following table for descriptions of the values you must edit in the deployment manifest:

<table>
  <tr>
    <th>Key-Value Pair</th>
    <th>Description</th>
  </tr>
  <tr>
    <td><pre>spec:<br>  replicas: 3</pre></td>
    <td>The number of pod replicas. Set this value to at least 2.</td>
  </tr>
  <tr>
    <td><pre>app: APP-NAME</pre></td>
    <td>The name of the app. Use this name when you define the anti-affinity rule later in the spec.</td>
  </tr>
  <tr>
    <td><pre>containers:  <br>- name: MY-APP<br>  image: MY-IMAGE</pre></td>
    <td></td>
  </tr>
  <tr>
    <td><pre>matchExpressions: <br>- key: "app"</pre></td>
    <td>This value matches <code>spec.template.metadata.labels.app</code>.</td>
  </tr>
  <tr>
    <td><pre>values: <br>- APP-NAME</pre></td>
    <td>This value matches the <code>APP-NAME</code> you defined earlier in the spec.</td>
  </tr>
</table>
